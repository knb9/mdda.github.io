---
date: 2015-01-12
title: Fedora 21 Server setup
category: OSS
tags:
- fedora
- linux
- fc21
layout: post
published: false
---
{% include JB/setup %}

This is the (almost) complete list of actions performed at the command line to 
bring up a 'desktop server' to 'operational standard' from USB drive 
with the 1.9Gb "Fedora Server ISO" installed on it onto
the server's brand new SSD drive.

### Update machine after initial USB install

This is using the machines actual console : 

{% highlight bash %}
yum install yum-plugin-fastestmirror
yum update
yum install joe
reboot
{% endhighlight %}

### Configure machine for static IP

Using [this helpful page](http://stackoverflow.com/questions/21432620/how-to-setup-static-ip-in-fedora-19) 
and again using the machine's actual console (so that remainder can be done via SSH) : 

{% highlight bash %}
ifconfig
# enp3s0 is the adapter name

joe /etc/sysconfig/network-scripts/ifcfg-enp3s0
------
TYPE="Ethernet"

#BOOTPROTO="dhcp"
BOOTPROTO=static
IPADDR=192.168.1.4
NETMASK=255.255.255.0
GATEWAY=192.168.1.1
DNS1=192.168.1.2

DEFROUTE="yes"
IPV4_FAILURE_FATAL="no"
IPV6INIT="yes"
IPV6_AUTOCONF="yes"
IPV6_DEFROUTE="yes"
IPV6_FAILURE_FATAL="no"
NAME="enp3s0"
UUID="4771d65c-037d-4806-aaca-d0aae1c1f05f"
ONBOOT="yes"
HWADDR="74:D4:35:85:F1:53"
PEERDNS="yes"
PEERROUTES="yes"
IPV6_PEERDNS="yes"
IPV6_PEERROUTES="yes"
------
{% endhighlight %}

Then, restart the interface (still at the console!!) :

{% highlight bash %}
ifdown enp3s0
ifup enp3s0
{% endhighlight %}

Check the contents of ```/etc/resolv.conf``` :

{% highlight bash %}
# Generated by NetworkManager
search herald
nameserver 192.168.1.2
{% endhighlight %}

Ok to reboot, and see whether keyboard is now necessary, etc : 

{% highlight bash %}
shutdown -h now
{% endhighlight %}


### Install essential tools

{% highlight bash %}
yum install git 
{% endhighlight %}

### Copy lots of stuff from previous HD

This was simple enough (once the appropriate entry was added to ```/etc/fstab``` to mount the old disk) :

{% highlight bash %}
#
# /etc/fstab
# Created by anaconda on Tue Jan 13 23:26:30 2015
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#

## This are the mounts created by the Fedora 21 installer
/dev/mapper/fedora--server-root /                       ext4    defaults        1 1
UUID=e03e963b-fcfc-44fe-a777-a7f3647858d7 /boot                   ext4    defaults        1 2
/dev/mapper/fedora--server-swap swap                    swap    defaults        0 0

# This is the new entry, with the 'device location' found by
# inspecting the contents of /dev/mapper (and contrasting with above)
/dev/mapper/fedora-root /mnt/data                       ext4    defaults        1 1
{% endhighlight %}

On to the copying :

{% highlight bash %}
# Internal 'sketchpad' for miscellaneous works-in-progree
rsync -avz --progress  /mnt/data/home/andrewsm/sketchpad .

# Bring over settings so that logins work elsewhere (clone old HD's settings)
rsync -avz --progress  /mnt/data/home/andrewsm/.ssh .
{% endhighlight %}

### More tools

Now that machine is looking more like home (and proven itself somewhat stable), 
pull in more heavy-weight packages :

{% highlight bash %}
yum install gcc python cmake make 
{% endhighlight %}





### Nvidia Proprietary Driver install (for Nvidia card)

http://www.if-not-true-then-false.com/2014/fedora-20-nvidia-guide/

{% highlight bash %}
yum localinstall --nogpgcheck http://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm http://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
lspci | grep -i nvidia
gcc --version
yum install akmod-nvidia "kernel-devel-uname-r == $(uname -r)"

## Backup old initramfs nouveau image ##
mv /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r)-nouveau.img
## Create new initramfs image ##
dracut /boot/initramfs-$(uname -r).img $(uname -r)
{% endhighlight %}


As detailed in [Nvidia's instructions](http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-linux/#axzz3OjOTroL4), 
get the CUDA repo RPM from [Nvidia's CUDA download page](https://developer.nvidia.com/cuda-downloads) :

{% highlight bash %}
wget http://developer.download.nvidia.com/compute/cuda/repos/fedora20/x86_64/cuda-repo-fedora20-6.5-14.x86_64.rpm
yum install cuda-repo-fedora*
yum install cuda
# This installs the JDK, mesa-libGL, lots of libX...
{% endhighlight %}




{% highlight bash %}
# NB: This is a 927Mb download...
wget http://developer.download.nvidia.com/compute/cuda/6_5/rel/installers/cuda_6.5.14_linux_64.run
{% endhighlight %}


   



{% highlight bash %}
yum install -y libbsd-devel libbsd glibc-devel libX11-devel help2man autoconf git tar glib2 glib2-devel kernel-devel kernel-headers automake gcc gtk2-devel
yum install VirtualGL 

yum -y --nogpgcheck install http://install.linux.ncsu.edu/pub/yum/itecs/public/bumblebee/fedora20/noarch/bumblebee-release-1.1-1.noarch.rpm
yum -y install bbswitch bumblebee

yum -y --nogpgcheck install http://install.linux.ncsu.edu/pub/yum/itecs/public/bumblebee-nonfree/fedora21/noarch/bumblebee-nonfree-release-1.1-1.noarch.rpm
yum -y install bumblebee-nvidia

touch /etc/sysconfig/nvidia/compile-nvidia-driver
reboot
{% endhighlight %}

### Make the Suspend of the NVidia GPU work

As per <a href="/oss/2014/11/26/FC20-acer-notebook-suspend-gpu/" target="_blank">instructions on this blog</a> :

{% highlight bash %}
# Check whether noveau or nvidia are currently running 
# (Should be '' for both)
lsmod | grep no
lsmod | grep nv

# This should give back results
optirun lsmod | grep nv
optirun --no-xorg modprobe -r nvidia
more /proc/acpi/bbswitch 

# Get the script from the blog post...
scite /usr/lib/systemd/system-sleep/turn-off-gpu.sh &
chmod 755 /usr/lib/systemd/system-sleep/turn-off-gpu.sh
/usr/lib/systemd/system-sleep/turn-off-gpu.sh pre suspend-test
more sleep.log 
{% endhighlight %}

### Install numpy / theano / ipython Prerequisits

{% highlight bash %}
yum install libyaml-devel zeromq-devel
yum install openblas-devel atlas-devel gcc-gfortran
yum install python-virtualenv
yum install libpng-devel freetype-devel
yum install hdf5-devel
{% endhighlight %}

### Install the CUDA toolkit

As per <a href="/oss/2014/11/21/install-nvidia-optimus-CUDA/" target="_blank">instructions on this blog</a> :

{% highlight bash %}
chmod 744 /home/andrewsm/Downloads/cuda_6.5.14_linux_64.run 
/home/andrewsm/Downloads/cuda_6.5.14_linux_64.run --override
echo "/usr/local/cuda-6.5/lib64" > /etc/ld.so.conf.d/cuda.conf && ldconfig
joe /home/andrewsm/.bash_profile 
{% endhighlight %}

### Install ```geany-project-tree``` plugin

{% highlight bash %}
yum install geany-plugins-geanypy

# launch geany and enable the GeanyPy plug (Tools Plugin Manager)
geany -i

# Download the geany-project-tree plugin, and install
mkdir tools
cd tools/
git clone https://github.com/mdda/geany-project-tree.git
cd geany-project-tree/
ln -s `pwd`/project-tree ~/.config/geany/plugins/geanypy/plugins/
# Load the plugin via Tools Python Plugin Manager
geany -i

# Test the installation (on the plugin's own setup, sample config provided)
cd geany-project-tree/
geany -i

# Just for convenience, enable git password caching (15 mins is default timeout)
git config --global credential.helper cache
# Set the cache to timeout after 1 hour (setting is in seconds)
git config --global credential.helper 'cache --timeout=3600'
{% endhighlight %}

### Remove superfluous RPMs

{% highlight bash %}
yum remove transmission* claws-mail* midori* 
yum remove pidgin* remmina* liferea* abiword* orage* parole* ristretto*
{% endhighlight %}

### RPMs required for 'ruby bundler' (for Jekyll - i.e. this blog)

{% highlight bash %}
yum install ruby-devel rubygem-bundler
yum install nodejs
{% endhighlight %}

Now, going into the project folder, do a ```bundle install``` to bring in the Ruby dependencies,
and this should allow local serving/testing of the content as follows :

{% highlight bash %}
bundle install 
bundle exec jekyll serve --watch --unpublished
{% endhighlight %}

### Install ```vlc```

(First checking which repositories worked best on previous machine) :

{% highlight bash %}
ls -l /mnt/hd/etc/yum.repos.d/
yum install http://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-21.noarch.rpm
yum install http://download1.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-21.noarch.rpm
yum install vlc
{% endhighlight %}

### Install Google Chrome

First, get the download from the [the Google Download site](https://www.google.com/chrome/browser/desktop/index.html), then :

{% highlight bash %}
yum install Downloads/google-chrome-stable_current_x86_64.rpm 
{% endhighlight %}

### Mount an SMB drive to copy some media files

{% highlight bash %}
# As a local user, create a suitable SMB credentials file : 
mkdir -i ~/.cifs
echo "user=username" >> ~/.cifs/viewqwest 
echo "password=password" >> ~/.cifs/viewqwest 

# and as root :
mkdir -p /mnt/media
mount -t cifs //viewqwest.herald/2tb /mnt/media -o rw,user,noauto,credentials=/home/andrewsm/.cifs/viewqwest,uid=andrewsm,gid=nobody
{% endhighlight %}

### Install EncFS (for sync-able encrypted folders)

This is for regular (sync-able) file-system files that can be 
encrypted/decrypted on the fly.  Very usefull in conjunction with ```unison``` :

{% highlight bash %}
yum install fuse-encfs

# remove '#' before user_allow_other
joe /etc/fuse.conf
{% endhighlight %}

The following script mounts an encrypted folder simply :
{% highlight bash %}
#!/bin/bash

#Capture the full path (required for mounting)
p=`pwd`
fusermount -u ${p}/Finance

DIALOGTEXT="Enter the Personal-Finance EncFS Password"
encfs \
 -o allow_other \
 --extpass="zenity --title 'EncFS Password' --entry --hide-text --text '$DIALOGTEXT'" \
 ${p}/.Finance-encfs/ ${p}/Finance/
{% endhighlight %}

And the following script un-mounts it :
{% highlight bash %}
#!/bin/bash
fusermount -u Finance
{% endhighlight %}


### Install Skype

First, install Skype from [http://www.skype.com/en/download-skype/skype-for-linux/](the Skype Linux download page) (the 32-bit Fedora one works).

Then, check that there are no pre-64-bit RPMs installed on the machine.  
That will (likely) prove that the Linux install is pure 64-bit native, meaning 
that (helpfully) Skype is the only reason that 32-bit packages are installed.
This in turn means that when it comes time to replace Skype with something
more Linux-friendly, it will be easier to remove it cleanly.

{% highlight bash %}
rpm -qa | grep i586
rpm -qa | grep i686
rpm -qa | grep i486
# NO 32-bit RPMs before Skype

yum install Downloads/skype-4.3.0.37-fedora.i586.rpm 
{% endhighlight %}

